name: Build OSM Database Weekly

on:
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  build-database:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Download Ontario OSM data
        run: |
          wget https://download.geofabrik.de/north-america/canada/ontario-latest.osm.pbf
          ls -lh ontario-latest.osm.pbf
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Download GraphHopper
        run: |
          wget https://github.com/graphhopper/graphhopper/releases/download/11.0/graphhopper-web-11.0.jar
          ls -lh graphhopper-web-11.0.jar
      
      - name: Create GraphHopper config
        run: |
          mkdir -p graph-cache
          cat > config.yml << 'EOF'
          graphhopper:
            datareader.file: ontario-latest.osm.pbf
            graph.location: graph-cache
            graph.encoded_values: car_access, car_average_speed, road_access

            import.osm.ignored_highways: footway,cycleway,path,pedestrian,steps
            
            profiles:
              - name: car_custom
                weighting: custom
                custom_model:
                  speed:
                    - if: "true"
                      limit_to: car_average_speed
                  priority:
                    - if: "road_access == DESTINATION"
                      multiply_by: 0
            profiles_ch:
              - profile: car_custom

            prepare.min_network_size: 200
            prepare.min_one_way_network_size: 200
          EOF
          cat config.yml
      
      - name: Build GraphHopper cache
        run: |
          java -Xmx4g -jar graphhopper-web-11.0.jar import config.yml
          ls -lh graph-cache/
          du -sh graph-cache/
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build Rust extractor
        run: |
          cargo build --release
          ls -lh target/release/osm-extractor
      
      - name: Extract OSM data
        run: |
          ./target/release/osm-extractor ontario-latest.osm.pbf
          ls -lh osm_data.db
          rm -f poi_data.json address_data.json
      
      - name: Create release bundle
        run: |
          mkdir ontario-routing-data
          cp osm_data.db ontario-routing-data/
          cp -r graph-cache ontario-routing-data/
          tar -czf ontario-routing-data_${{ steps.date.outputs.date }}.tar.gz ontario-routing-data/
          ls -lh ontario-routing-data_*.tar.gz
          du -sh ontario-routing-data/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: routing-${{ steps.date.outputs.date }}
          name: Routing Data - ${{ steps.date.outputs.date }}
          body: |
            Pre-built routing data for Ontario
            
            Includes:
            - POI Database (SQLite)
            - GraphHopper Graph Cache (CH Enabled: car_custom)
            
            Built from ontario-latest.osm.pbf
          files: |
            ontario-routing-data_*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Clean up old releases
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 4
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}