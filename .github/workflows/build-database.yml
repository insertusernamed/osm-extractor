name: Build OSM Database Weekly

on:
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  build-database:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Download Ontario OSM data
        run: |
          wget https://download.geofabrik.de/north-america/canada/ontario-latest.osm.pbf
          ls -lh ontario-latest.osm.pbf
      
      - name: Build Rust extractor
        run: |
          cargo build --release
          ls -lh target/release/osm-extractor
      
      - name: Extract OSM data
        run: |
          ./target/release/osm-extractor ontario-latest.osm.pbf
          ls -lh osm_data.db
      
      - name: Compress database
        run: |
          gzip -9 osm_data.db
          mv osm_data.db.gz osm_data_${{ steps.date.outputs.date }}.db.gz
          ls -lh osm_data_*.db.gz
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: osm-${{ steps.date.outputs.date }}
          name: OSM Database - ${{ steps.date.outputs.date }}
          body: |
            Pre-built OSM database for Ontario
            - Built: ${{ steps.date.outputs.date }}
            - Source: ontario-latest.osm.pbf from Geofabrik
          files: |
            osm_data_*.db.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Clean up old releases
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 4
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}